# Assign prev_country to Australia to enable loop
prev_country <- "Australia"
# Set the first row's total_cases to its new_cases
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
if (current_country == prev_country&&
current_date == prev_date + 1) {
# cumulative total = previous total + current new_cases
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
}
#Do not override total cases if there is a missing date
if (current_country == prev_country&&
current_date != prev_date +1) {
next
}
else {
# new country do NOT override existing total_cases
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
}
#update trackers
prev_country <- current_country
prev_date    <- current_date
}
#Examine case/ death columns for negative values
filter(negative_val_loop[c(188,189,190,191),])
View(negative_val_loop)
# Set the first row's total_cases to its new_cases
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
if (current_country == prev_country) {
# same country, consecutive date → update cumulative
if (current_date == prev_date + 1) {
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
}
# same country, but date skipped → do nothing, keep existing total_cases
} else {
# new country → reset cumulative from new_cases
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
}
# always update trackers
prev_country <- current_country
prev_date    <- current_date
}
#Examine case/ death columns for negative values
filter(negative_val_loop[c(186,187,188,189,190,191),])
# Initialize first row of dataset
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# Case 1: new country → reset cumulative
if (current_country != prev_country) {
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
# Case 2: same country AND consecutive date → cumulative update
} else if (current_date == prev_date + 1) {
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
# Case 3: same country BUT date skipped → keep existing total_cases
} else {
# do nothing
}
# update trackers
prev_country <- current_country
prev_date    <- current_date
}
View(negative_val_loop)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
#import Covid dataset
Covid.data <- read.csv(here("Raw Data", "Covid-data.csv"),)
head(Covid.data)
#Selecting rows with missing data
Covid.data_missing <- Covid.data[!complete.cases(Covid.data), ]
Covid.data_missing
# Start with a clean copy
covid.data_tidy <- Covid.data %>%
arrange(location, date) %>%   # ensure correct chronological order
mutate(row_id = row_number())
# Impute missing total_deaths using cumulative logic
# Identify rows where total_deaths is missing
missing_total <- covid.data_tidy %>%
filter(is.na(total_deaths)) %>%
pull(row_id)
# Reconstruct total_deaths using previous day's cumulative total
covid.data_tidy <- covid.data_tidy %>%
mutate(
total_deaths = if_else(
is.na(total_deaths),
lag(total_deaths) + new_deaths,
total_deaths
)
)
# Inspect affected rows
covid.data_tidy %>%
slice(sort(c(missing_total - 1, missing_total)))
#calculate missing values for new deaths
# Identify rows where new_deaths is missing
missing_new <- covid.data_tidy %>%
filter(is.na(new_deaths)) %>%
pull(row_id)
# Reconstruct new_deaths using difference between cumulative totals
covid.data_tidy <- covid.data_tidy %>%
mutate(
new_deaths = if_else(
is.na(new_deaths),
total_deaths - lag(total_deaths),
new_deaths
)
)
# Inspect affected rows to check new deaths columns
covid.data_tidy %>%
slice(sort(c(missing_new - 1, missing_new)))
# Filter row based on location and date and replace new and total deaths values to 0
covid.data_tidy <- covid.data_tidy %>%
mutate(
total_deaths = if_else(
location == "United Kingdom" &
date == as.Date("2020-01-19") &
is.na(total_deaths),
0,
total_deaths
),
new_deaths = if_else(
location == "United Kingdom" &
date == as.Date("2020-01-19") &
is.na(new_deaths),
0,
new_deaths
)
)
# Inspect affected rows
covid.data_tidy %>%
filter(location == "United Kingdom",
as.Date(date) == as.Date("2020-01-19"))
# --- 1. Calculate missing total_deaths for 2020-05-01 ---
# Values from 2020-05-02
us_total_0502 <- covid.data_tidy %>%
filter(location == "United States",
date == as.Date("2020-05-02")) %>%
pull(total_deaths)
us_new_0502 <- covid.data_tidy %>%
filter(location == "United States",
date == as.Date("2020-05-02")) %>%
pull(new_deaths)
# Update total_deaths for 2020-05-01
covid.data_tidy <- covid.data_tidy %>%
mutate(
total_deaths = if_else(
location == "United States" &
date == as.Date("2020-05-01") &
is.na(total_deaths),
us_total_0502 - us_new_0502,
total_deaths
)
)
# --- 2. Calculate missing new_deaths for 2020-05-01 ---
# Values from 2020-05-01 and 2020-04-30
us_total_0501 <- covid.data_tidy %>%
filter(location == "United States",
date == as.Date("2020-05-01")) %>%
pull(total_deaths)
us_total_0430 <- covid.data_tidy %>%
filter(location == "United States",
date == as.Date("2020-04-30")) %>%
pull(total_deaths)
# Update new_deaths for 2020-05-01
covid.data_tidy <- covid.data_tidy %>%
mutate(
new_deaths = if_else(
location == "United States" &
date == as.Date("2020-05-01") &
is.na(new_deaths),
us_total_0501 - us_total_0430,
new_deaths
)
)
#view column to check updated values
covid.data_tidy %>%
filter(location == "United States",
date == as.Date("2020-05-01"))
#Check for missing values
covid.data_tidy[!complete.cases(covid.data_tidy), ]
CountryLockdowndates <- read.csv(here("Raw Data", "CountryLockdowndates.csv"))
head(CountryLockdowndates, 10)
#Select rows with missing data
CountryLockdowndates_missing <- CountryLockdowndates[!complete.cases(CountryLockdowndates), ]
CountryLockdowndates_missing
#Import worldwide vaccine data table
WorldwideVaccineData <- read.csv(here("Raw Data", "WorldwideVaccineData.csv"), header=TRUE)
head(WorldwideVaccineData)
#Select missing data
vaccine_missing <- WorldwideVaccineData[!complete.cases(WorldwideVaccineData), ]
vaccine_missing
#Converting CountryLockdowndates dates column to yyyy-mm-dd
for (index in seq_along(CountryLockdowndates[,3])){
date <- CountryLockdowndates[index ,3]
if (date != ""){
input_date <- as.Date(date, format = "%d/%m/%Y")
CountryLockdowndates[index, 3] <- format(input_date, "%Y-%m-%d")
}
}
head(CountryLockdowndates, 10)
#renaming CountryLockdowndates columns country.region to location and date to lockdown date
names(CountryLockdowndates)[names(CountryLockdowndates) == "Country.Region"] <- "location"
names(CountryLockdowndates)[names(CountryLockdowndates) == "Date"] <- "lockdown_date"
# add new data frame to manipulate
lock_down <- CountryLockdowndates
#select all countries with duplicates
lock_down <- lock_down %>%
arrange(location, lockdown_date) %>%
filter(duplicated(location)== TRUE)
#select to only display location and lockdown_date
lock_down <- subset(lock_down, select = c(location, lockdown_date))
#Display first 10 rows
head(lock_down,10)
#add new data frame to manipulate
lock_down <- CountryLockdowndates
#Remove duplicate countries
lock_down <- lock_down %>%
arrange(location, lockdown_date) %>%
filter(duplicated(location)== FALSE)
#select to only display location and lockdown_date
lock_down <- subset(lock_down, select = c(location, lockdown_date))
#Assign earliest lockdown dates to duplicate countries
lock_down[9,2] <- "2020-03-24" #Australia
lock_down[32,2] <- "2020-03-14" #Canada
lock_down[36,2] <- "2020-01-23" #China
lock_down[61,2] <- "2020-03-16" #France
lock_down[120,2] <- "2020-03-16" #Netherlands
lock_down[170,2] <- "2020-03-13" #US
lock_down[174,2] <- "2020-03-18" #United Kingdom
#renaming worldwidevaccinedata country column to location
names(WorldwideVaccineData)[names(WorldwideVaccineData) == "Country"] <- "location"
#inner join covid.data_tidy to worldwidevaccinedata on location column
covid_data_vaccine_join <- inner_join(covid.data_tidy, WorldwideVaccineData, by = "location")
head(covid_data_vaccine_join)
#Joining covide_data_vaccine_join with countrylockdowndates
covid_data_joined <- inner_join(covid_data_vaccine_join, lock_down, by = "location")
head(covid_data_joined)
#remove columns that are not needed
covid_data_joined <- subset(covid_data_joined, select = -c(Doses.administered.per.100.people, X..of.population.vaccinated, row_id))
#rename columns
names(covid_data_joined)[names(covid_data_joined) == "Total.doses.administered"] <- "total_doses_administered"
names(covid_data_joined)[names(covid_data_joined) == "X..of.population.vaccinated"] <- "%_of_population_fully_vaccinated"
head(covid_data_joined)
#Convert date column from chr data type to date data type
covid_data_joined <- mutate(covid_data_joined, date = as.Date(date, format = "%Y-%m-%d"))
#Convert lockdown_date column from chr data type to date data type
covid_data_joined <- mutate(covid_data_joined, lockdown_date = as.Date(lockdown_date, format = "%Y-%m-%d"))
#check for errors or missing values
covid_data_joined_missing <- covid_data_joined[!complete.cases(covid_data_joined), ]
head(covid_data_joined_missing)
#Assigning loop output to a new variable
date_correct_loop <- covid_data_joined
#For loop to search date column to find na and replace it with date from previous index +1 day
for(index in seq_along(date_correct_loop[,2])){
if(is.na(date_correct_loop[index,2])){
date_correct_loop[index,2] <- date_correct_loop[index-1,2]+1
}
}
#Check for missing values
date_correct_loop[!complete.cases(date_correct_loop), ]
#Check previous missing indexes for correct date changes
date_correct_loop[c(162, 163, 164, 165, 166, 213, 214, 215), ]
#Examine case/ death columns for negative values
if (count(filter(date_correct_loop, total_cases < 0)) >0){
print("Negative values in: total_cases")
}
if (count(filter(date_correct_loop, new_cases < 0)) >0){
print("Negative values in: new_cases")
}
if (count(filter(date_correct_loop, total_deaths < 0)) >0){
print("Negative values in: total_deaths")
}
if (count(filter(date_correct_loop, new_deaths < 0)) >0){
print("Negative values in: new_deaths")
}
#Select rows with negative data
negative_values <- filter(date_correct_loop, new_deaths <0 | new_cases <0)
negative_values
#Examine dates before the rows with negative values to check if negative values can be multiplied by -1
filter(date_correct_loop, date == "2020-06-05" & location == "France")
filter(date_correct_loop, date == "2020-06-24" & location == "Italy")
filter(date_correct_loop, date == "2020-04-18" & location == "Spain")
filter(date_correct_loop, date == "2020-05-24" & location == "Spain")
#Assign loop variable for negative values loop
negative_val_loop <- date_correct_loop
#For loop to search for rows with negative values in new_cases, multiply the value be -1 and add the value to correct the corresponding total column
for(i in seq_along(negative_val_loop[,4])){
if (negative_val_loop[i,4] < 0){
negative_val_loop[i,4] <- negative_val_loop[i,4] * -1
negative_val_loop[i,3] <- negative_val_loop[i,3] + negative_val_loop[i,4]
}
}
#Check for negative values in new_cases
filter(negative_val_loop, new_cases < 0)
#For loop to search for rows with negative values in new_deaths, multiply the value be -1 and add the value to correct the corresponding total column
for(i in seq_along(negative_val_loop[,6])){
if (negative_val_loop[i,6] < 0){
negative_val_loop[i,6] <- negative_val_loop[i,6] * -1
negative_val_loop[i,5] <- negative_val_loop[i,5] + negative_val_loop[i,6]
}
}
#Check for negative values in new_deaths
filter(negative_val_loop, new_cases < 0)
#Examine case/ death columns for negative values
filter(negative_val_loop[c(188,189,190,191),])
# Initialize first row of dataset
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# Case 1: new country → reset cumulative
if (current_country != prev_country) {
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
# Case 2: same country AND consecutive date → cumulative update
} else if (current_date == prev_date + 1) {
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
# Case 3: same country BUT date skipped → keep existing total_cases
} else {
# do nothing
}
# update trackers
prev_country <- current_country
prev_date    <- current_date
}
# Set the first row's total_cases to its new_cases
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
# track whether we've seen a non-zero new_cases for the current country
seen_nonzero <- negative_val_loop[1, 4] > 0
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# new country → reset state
if (current_country != prev_country) {
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
seen_nonzero <- negative_val_loop[i, 4] > 0
} else if (current_date == prev_date + 1) {
if (!seen_nonzero && negative_val_loop[i, 4] > 0) {
# first non-zero new_cases for this country
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
seen_nonzero <- TRUE
} else if (seen_nonzero) {
# normal cumulative behaviour
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
} else {
# still all zeros so far
negative_val_loop[i, 3] <- 0
}
} else {
# same country but date skipped → keep existing total_cases
# (do nothing)
}
prev_country <- current_country
prev_date    <- current_date
}
#Examine case/ death columns for negative values
filter(negative_val_loop[c(186,187,188,189,190,191),])
# Initialize first row of dataset
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# Case 1: new country → reset cumulative
if (current_country != prev_country) {
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
# Case 2: same country AND consecutive date → cumulative update
} else if (current_date == prev_date + 1) {
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
# Case 3: same country BUT date skipped → keep existing total_cases
} else {
# do nothing
}
# update trackers
prev_country <- current_country
prev_date    <- current_date
}
# Initialize first row of dataset
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# Case 1: new country → reset cumulative
if (current_country != prev_country) {
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
# Case 2: same country AND consecutive date → cumulative update
} else if (current_date == prev_date + 1) {
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
# Case 3: same country BUT date skipped → keep existing total_cases unless new_cases > total_cases - previous total_cases then add new_cases and previous total_cases together
} else { if (negative_val_loop[i,3] < negative_val_loop[i-1,3] +
negative_val_loop[i,4]){
negative_val_loop[i,3] <- negative_val_loop[i,4] + negative_val_loop[i-1,3]
}
# do nothing
}
# update trackers
prev_country <- current_country
prev_date    <- current_date
}
# Initialize first row of dataset
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# Case 1: new country → reset cumulative
if (current_country != prev_country) {
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
# Case 2: same country and first non-zero total_cases
} else if (negative_val_loop[i-1,3] == 0 &&
negative_val_loop[i-1,4] == 0) {
negative_val_loop[i,3] < negative_val_loop[i,4]
# Case 3: same country AND consecutive date → cumulative update
} else if (current_date == prev_date + 1) {
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
# Case 4: same country BUT date skipped → keep existing total_cases unless new_cases > total_cases - previous total_cases then add new_cases and previous total_cases together
} else { if (negative_val_loop[i,3] < negative_val_loop[i-1,3] +
negative_val_loop[i,4]){
negative_val_loop[i,3] <- negative_val_loop[i,4] + negative_val_loop[i-1,3]
}
}
# update trackers
prev_country <- current_country
prev_date    <- current_date
}
# Initialize first row of dataset
negative_val_loop[1, 3] <- negative_val_loop[1, 4]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# Case 1: new country → reset cumulative
if (current_country != prev_country) {
negative_val_loop[i, 3] <- negative_val_loop[i, 4]
# Case 2: same country and first non-zero total_cases
} else if (negative_val_loop[i-1,3] == 0 &&
negative_val_loop[i-1,4] == 0) {
negative_val_loop[i,3] <- negative_val_loop[i,4]
# Case 3: same country AND consecutive date → cumulative update
} else if (current_date == prev_date + 1) {
negative_val_loop[i, 3] <- negative_val_loop[i - 1, 3] + negative_val_loop[i, 4]
# Case 4: same country BUT date skipped → keep existing total_cases unless new_cases > total_cases - previous total_cases then add new_cases and previous total_cases together
} else { if (negative_val_loop[i,3] < negative_val_loop[i-1,3] +
negative_val_loop[i,4]){
negative_val_loop[i,3] <- negative_val_loop[i,4] + negative_val_loop[i-1,3]
}
}
# update trackers
prev_country <- current_country
prev_date    <- current_date
}
# Initialize first row of dataset
negative_val_loop[1, 5] <- negative_val_loop[1, 6]
prev_country <- negative_val_loop[1, 1]
prev_date    <- negative_val_loop[1, 2]
for (i in 2:nrow(negative_val_loop)) {
current_country <- negative_val_loop[i, 1]
current_date    <- negative_val_loop[i, 2]
# Case 1: new country → reset cumulative
if (current_country != prev_country) {
negative_val_loop[i, 5] <- negative_val_loop[i, 6]
# Case 2: same country and first non-zero total_deaths → convert total_deaths to new_deaths
} else if (negative_val_loop[i-1,5] == 0 &&
negative_val_loop[i-1,6] == 0) {
negative_val_loop[i,5] <- negative_val_loop[i,6]
# Case 3: same country AND consecutive date → cumulative update
} else if (current_date == prev_date + 1) {
negative_val_loop[i, 5] <- negative_val_loop[i - 1, 5] + negative_val_loop[i, 6]
# Case 4: same country BUT date skipped → keep existing total_deaths unless new_deaths > total_cases - previous total_deaths then add new_deaths and previous total_deaths together
} else { if (negative_val_loop[i,5] < negative_val_loop[i-1,5] +
negative_val_loop[i,6]){
negative_val_loop[i,5] <- negative_val_loop[i,6] + negative_val_loop[i-1,5]
}
}
# update trackers
prev_country <- current_country
prev_date    <- current_date
}
#Examine case/ death columns for negative values
filter(negative_val_loop[c(189,190,191),])
#Examine case/ death columns for negative values
filter(negative_val_loop, new_deaths <0 | new_cases <0)
#Examine case/ death columns for negative values
filter(negative_val_loop, new_deaths <0 | new_cases <0)
#Plot a line graph using the clean covid data examining new cases over time
ggplot(data = negative_val_loop, aes(x = date, y = new_cases, group = location, color = location))+
geom_line(linewidth = 0.5)+
#Split plot by country, give each plot its own scale
facet_grid(rows = vars(location), scales = "free")
#filter Iran data by rows with 0 new_cases.
head(filter(negative_val_loop, new_cases == 0 & location == "Iran"))
unlink("R- Covid_project_cache", recursive = TRUE)
